# GONE 
# 1. generate file ped/map
# plink
# --allow-extra-chr
#  --chr VXBX01009921.1,VXBX01004249.1,VXBX01003474.1,VXBX01008609.1,VXBX01002725.1,VXBX01005888.1,VXBX01003014.1,VXBX01007701.1,VXBX01003755.1,VXBX01008695.1,VXBX01007125.1,VXBX01008236.1,VXBX01009439.1,VXBX01001056.1,VXBX01001501.1,VXBX01007795.1,VXBX01004397.1,VXBX01007997.1,VXBX01008145.1,VXBX01008674.1,VXBX01003991.1,VXBX01001608.1,VXBX01006871.1,VXBX01006773.1,VXBX01001698.1,VXBX01000547.1,VXBX01009827.1,VXBX01004616.1,VXBX01001175.1,VXBX01003868.1,VXBX01005266.1,VXBX01005702.1,VXBX01004221.1,VXBX01004071.1,VXBX01008400.1,VXBX01002109.1,VXBX01002369.1,VXBX01006211.1,VXBX01009452.1,VXBX01008453.1,VXBX01003936.1,VXBX01005247.1,VXBX01000994.1,VXBX01004400.1,VXBX01000771.1,VXBX01001798.1,VXBX01000098.1,VXBX01001503.1,VXBX01001802.1,VXBX01001954.1,VXBX01004936.1,VXBX01008007.1,VXBX01004435.1,VXBX01005595.1,VXBX01007086.1,VXBX01004450.1,VXBX01005113.1,VXBX01004609.1,VXBX01002494.1,VXBX01000330.1,VXBX01001361.1,VXBX01006700.1,VXBX01004000.1,VXBX01009318.1,VXBX01006882.1,VXBX01003661.1,VXBX01005110.1,VXBX01000100.1,VXBX01002915.1,VXBX01005896.1,VXBX01009614.1,VXBX01000457.1,VXBX01004089.1,VXBX01001194.1,VXBX01003997.1,VXBX01006887.1,VXBX01008140.1,VXBX01009446.1,VXBX01002337.1,VXBX01002499.1,VXBX01003108.1,VXBX01007602.1,VXBX01008012.1,VXBX01000798.1,VXBX01008146.1,VXBX01004959.1,VXBX01002127.1,VXBX01005325.1,VXBX01009357.1,VXBX01004892.1,VXBX01017515.1,VXBX01000899.1,VXBX01002742.1,VXBX01007003.1,VXBX01003871.1,VXBX01001289.1,VXBX01008995.1,VXBX01004429.1,VXBX01008125.1,VXBX01007486.1,VXBX01001890.1,VXBX01001788.1,VXBX01008464.1,VXBX01002496.1,VXBX01009582.1,VXBX01009108.1,VXBX01008036.1,VXBX01003639.1,VXBX01003761.1,VXBX01002012.1,VXBX01001702.1,VXBX01004312.1,VXBX01000991.1,VXBX01009535.1,VXBX01005992.1,VXBX01008133.1,VXBX01009899.1,VXBX01006127.1,VXBX01004442.1,VXBX01005472.1,VXBX01002363.1,VXBX01009038.1,VXBX01003097.1,VXBX01008045.1,VXBX01004732.1,VXBX01000450.1,VXBX01009313.1,VXBX01006201.1,VXBX01009908.1,VXBX01003745.1,VXBX01005001.1,VXBX01005335.1,VXBX01008206.1,VXBX01006518.1,VXBX01006808.1,VXBX01009605.1,VXBX01000364.1,VXBX01003748.1,VXBX01007981.1,VXBX01000659.1,VXBX01000122.1,VXBX01001580.1,VXBX01005473.1,VXBX01000774.1,VXBX01001934.1,VXBX01003777.1,VXBX01006128.1,VXBX01006417.1,VXBX01002579.1,VXBX01004176.1,VXBX01000995.1,VXBX01004733.1,VXBX01009292.1,VXBX01007708.1,VXBX01000560.1,VXBX01006119.1,VXBX01006869.1,VXBX01000786.1,VXBX01004178.1,VXBX01005740.1,VXBX01009752.1,VXBX01003000.1,VXBX01009469.1,VXBX01005327.1,VXBX01004046.1,VXBX01000010.1,VXBX01007914.1,VXBX01002712.1,VXBX01006519.1,VXBX01007493.1,VXBX01004838.1,VXBX01009008.1,VXBX01005349.1,VXBX01006670.1,VXBX01005118.1,VXBX01003483.1,VXBX01009832.1,VXBX01008688.1,VXBX01008451.1,VXBX01005245.1,VXBX01001047.1,VXBX01009855.1,VXBX01007777.1,VXBX01001585.1,VXBX01008290.1,VXBX01002916.1,VXBX01004599.1,VXBX01009584.1,VXBX01004943.1,VXBX01005867.1,VXBX01008415.1,VXBX01003747.1,VXBX01000102.1,VXBX01002566.1,VXBX01007692.1,VXBX01003263.1,VXBX01009215.1,VXBX01006199.1,VXBX01003191.1,VXBX01008231.1,VXBX01007117.1,VXBX01007491.1,VXBX01001600.1,VXBX01007131.1,VXBX01005210.1,VXBX01009114.1,VXBX01001290.1,VXBX01002809.1,VXBX01003377.1,VXBX01005253.1,VXBX01005186.1,VXBX01009069.1,VXBX01001048.1,VXBX01005632.1,VXBX01000768.1
#  --out Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10
#  --recode
#  --vcf Lin1_bigger500kbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_GeographicNames_allsamples.vcf.recode.vcf.gz

# 2. organize the map file 
# change scaffolds to chr : 
  # awk '!seen[$1]++ { chr++; map[$1]=chr } { print map[$1], $2, $3, $4 }' Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr.map > Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr.map
  # cp Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10.ped Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr.ped
# add snp numbers to each snp 
  # awk '{$2=NR; print}' Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr.map > Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr1.map
  # mv Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr1.map Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr.map
# move the files to the GONE directory
  # mv Lin1_bigger1Mbscaffolds_FilteredPCAandUCE_Max30missingDepthmin10_chr* ~/Scytalopus/GONE/Linux/

# 3. run GONE
# before running:       
  #export TMPDIR="$(pwd)/tmp"
  #export TEMP="$TMPDIR"
  #export TMP="$TMPDIR"
# bash scrip_GONE.sh filemap/ped

# 4. plot in R 
# Read GONE output
library(ggplot2)
setwd("./")
gone <- read.table("Output_Ne_fixed", header = TRUE, skip=1)

# Detect format
if (ncol(gone) == 2) {
  colnames(gone) <- c("Generation", "Ne")
} else {
  colnames(gone) <- c("Generation", "Ne", "Ne_low", "Ne_high")
}

g <- 3.2  # example
gone$Years <- gone$Generation * g

pdf("teste.pdf",,width = 10,height = 10)
ggplot(gone, aes(x = Generation, y = Ne)) +
  geom_line(linewidth = 1) +
  scale_x_log10() +
  labs(
    x = "Generations in the past",
    y = "Effective population size (Ne)",
    title = "Demographic history inferred by GONE"
  ) +
  theme_classic()

ggplot(gone, aes(x = Generation, y = Ne)) +
  geom_ribbon(aes(ymin = Ne_low, ymax = Ne_high), fill = "grey80") +
  geom_line(linewidth = 1) +
  scale_x_log10() +
  theme_classic()
dev.off()

# Plot
plot(
  gone$Generation,
  gone$Ne,
  type = "l",
  log = "x",
  lwd = 2,
  xlab = "Generations in the past",
  ylab = "Effective population size (Ne)",
  main = "Demographic history inferred by GONE"
)

# Add CI if present
if ("Ne_low" %in% colnames(gone)) {
  polygon(
    c(gone$Generation, rev(gone$Generation)),
    c(gone$Ne_low, rev(gone$Ne_high)),
    col = rgb(0.7, 0.7, 0.7, 0.5),
    border = NA
  )
  lines(gone$Generation, gone$Ne, lwd = 2)
}
